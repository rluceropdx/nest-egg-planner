<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <title>Nest Egg Planner/Simulation WebSocket Client</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial;
            margin: 18px;
            background: #f7f8fb;
            color: #111;
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 14px;
            box-shadow: 0 6px 18px rgba(20, 20, 40, 0.06);
            max-width: 900px;
            margin: auto;
        }

        .row {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-bottom: 10px;
        }

        input[type=text],
        select,
        textarea {
            padding: 8px;
            border-radius: 6px;
            border: 1px solid #d6d9e6;
            font-size: 14px;
        }

        button {
            padding: 8px 12px;
            border-radius: 8px;
            border: 0;
            cursor: pointer;
            background: #2563eb;
            color: #fff;
            font-weight: 600;
        }

        #log {
            height: 360px;
            overflow: auto;
            border: 1px solid #eef0f6;
            padding: 8px;
            border-radius: 8px;
            background: #fbfcff;
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
            font-size: 13px;
        }

        .msg {
            padding: 6px 8px;
            border-radius: 6px;
            margin-bottom: 6px;
        }

        .incoming {
            background: #eef9ff;
            border-left: 4px solid #60a5fa;
        }

        .outgoing {
            background: #f1fdf7;
            border-left: 4px solid #34d399;
        }

        .system {
            background: #fff7ed;
            border-left: 4px solid #f59e0b;
        }

        .meta {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 6px;
        }

        label {
            font-size: 13px;
            color: #374151;
        }
    </style>
</head>

<body>
    <div class="card">
        <h2>Nest Egg Planner/Simulation WebSocket Client</h2>

        <div class="row">
            <label>Age</label>
            <input type="text" id="age" value="35" class="input_field">
        </div>

        <div class="row">
            <label>Annual Savings (whole dollars)</label>
            <input type="text" id="current_savings" value="5000" class="input_field">
        </div>

        <div class="row">
            <label>Annual Salary (whole dollars)</label>
            <input type="text" id="current_salary" value="75000" class="input_field">
        </div>

        <div class="row">
            <label>Expenses During Retirement (whole dollars)</label>
            <input type="text" id="retirement_expenses" value="45000" class="input_field">
            <button id="sendBtn" disabled>Send</button>
        </div>

        <div class="row">
            <label>Status:</label>
            <div id="status" class="meta">Disconnected</div>
        </div>

        <h2>Nest Egg Planner/Simulation</h2>
        <svg id="chart" width="600" height="300"></svg>
        <div id="log" aria-live="polite"></div>

    </div>

    <script>
        function drawChart(data) {
            const svg = d3.select("#chart");
            const width = +svg.attr("width");
            const height = +svg.attr("height");
            const margin = { top: 20, right: 30, bottom: 30, left: 80 };

            // Scales
            const x = d3.scaleLinear()
                .domain([d3.min(data, d => d.age), d3.max(data, d => d.age)])
                .range([margin.left, width - margin.right]);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.savings)])
                .range([height - margin.bottom, margin.top]);

            // Line generator
            const line = d3.line()
                .x(d => x(d.age))
                .y(d => y(d.savings));

            // Draw axes
            svg.append("g")
                .attr("transform", `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x).ticks(5)); // .tickFormat(d => Number.isInteger(d) ? d : ""));

            svg.append("g")
                .attr("transform", `translate(${margin.left},0)`)
                .call(d3.axisLeft(y));

            // Draw line
            svg.append("path")
                .datum(data)
                .attr("fill", "none")
                .attr("stroke", "steelblue")
                .attr("stroke-width", 2)
                .attr("d", line)
                .transition()
                .duration(10000);

            // Slow-draw animation
            // const totalLength = path.node().getTotalLength();

            // path
            //     .attr("stroke-dasharray", totalLength + " " + totalLength)
            //     .attr("stroke-dashoffset", totalLength)
            //     .transition()
            //     .duration(10000)   // ðŸŽ¬ 3 seconds â€” adjust speed here
            //     .ease(d3.easeLinear)
            //     .attr("stroke-dashoffset", 0);

        }

        function redraw(data) {
            const svg = d3.select("#chart");
            svg.selectAll("*").remove();
            drawChart(data);
        }

        // Elements
        const ageInput = document.getElementById('age');
        const savingsInput = document.getElementById('current_savings');
        const salaryInput = document.getElementById('current_salary');
        const retirementExpInput = document.getElementById('retirement_expenses');
        const sendBtn = document.getElementById('sendBtn');
        const statusEl = document.getElementById('status');
        const logEl = document.getElementById('log');
        const inputEls = document.getElementsByClassName("input_field");
        console.log('inputEls', inputEls)
        let ws = null;

        function addLog(text, kind = 'system') {
            const el = document.createElement('div');
            el.className = 'msg ' + (kind === 'incoming' ? 'incoming' : kind === 'outgoing' ? 'outgoing' : 'system');
            const time = new Date().toLocaleTimeString();

            try {
                const serverData = JSON.parse(text);
                if (serverData.hasOwnProperty('result')) {
                    console.log('serverData result', serverData.result);
                }
            } catch (e) {
                console.log('error parsing json', e);
            }


            el.innerHTML = `<div class="meta">${time} â€” ${kind.toUpperCase()}</div><div>${escapeHtml(text)}</div>`;
            logEl.appendChild(el);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function escapeHtml(s) {
            if (typeof s !== 'string') s = String(s);
            return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;').replaceAll('"', '&quot;');
        }

        function setStatus(text, color) {
            statusEl.textContent = text;
            statusEl.style.color = color || '';
        }

        if (ws) {
            addLog('Already connected (or connecting).', 'system');
        }
        const url = 'http://127.0.0.1:3030/ws'; //

        try {
            // Create WebSocket
            ws = new WebSocket(url);

            setStatus('Connecting...', '#d97706');

            // Events
            ws.addEventListener('open', (ev) => {
                setStatus('Connected to ' + url, '#10b981');
                addLog('Connection opened', 'system');
                sendBtn.disabled = false;
            });

            ws.addEventListener('message', (event) => {
                try {
                    const server_data = JSON.parse(event.data)
                    if (server_data.hasOwnProperty('status') && server_data.status == "simulation completed") {
                        redraw(server_data.results.processed);
                    }
                } catch (e) {
                    console.log('error parsing event.data', e)
                }

                // Distinguish text vs binary
                if (typeof event.data === 'string') {
                    addLog(event.data, 'incoming');
                }
            });

            ws.addEventListener('close', (ev) => {
                addLog(`Closed (code: ${ev.code}, reason: ${ev.reason || 'none'})`, 'system');
                setStatus('Disconnected', '#ef4444');
                ws = null;
                sendBtn.disabled = true;
            });

            ws.addEventListener('error', (err) => {
                addLog('WebSocket error (see console)', 'system');
                console.error('WebSocket error', err);
                setStatus('Error', '#b91c1c');
            });

        } catch (err) {
            addLog('Failed to create WebSocket: ' + err.message, 'system');
        }


        for (const element of inputEls) {
            element.addEventListener('blur', (event) => {
                if (event.target.value.includes(".")) {
                    event.target.value = (/[a-zA-Z]/.test(event.target.value)) ? 0 : Math.round(event.target.value);
                } else {
                    event.target.value = event.target.value.replace(/\D/g, '');
                }
            });
        }

        sendBtn.addEventListener('click', () => {
            if (!ws || ws.readyState !== WebSocket.OPEN) { addLog('Socket is not open', 'system'); return; }

            let value = `{  "action":"simulate", 
                            "age":${ageInput.value}, 
                            "current_savings":${savingsInput.value}, 
                            "current_salary":${salaryInput.value}, 
                            "retirement_expenses":${retirementExpInput.value}   }`;

            try {
                // Attempt to parse then serialize to ensure valid JSON
                const parsed = JSON.parse(value);
                value = JSON.stringify(parsed);
            } catch (e) {
                addLog('Invalid JSON â€” fix it before sending.', 'system');
                return;
            }

            try {
                ws.send(value);
                addLog(value, 'outgoing');
            } catch (e) {
                addLog('Send failed: ' + e.message, 'system');
            }
        });
    </script>
</body>

</html>